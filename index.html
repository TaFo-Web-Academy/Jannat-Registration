<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –ö–æ–Ω–∫—É—Ä—Å 8 –ù–æ—è–±—Ä—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div id="app-container" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all">

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-black mb-2">
             üìÖ –†”Ø–∑: 8 –Ω–æ—è–±—Ä 2025
            </h1>
            <p class="text-gray-600 text-lg">
  üìç –ú–ê–™–õ–£–ú–û–¢–ò –¢–†–ï–ù–ò–ù–ì   
‚îÇ  üë• “∂–æ–∏ –º–∞“≥–¥—É–¥: 40 –Ω–∞—Ñ–∞—Ä  üìç “∂–æ–π: –î—É—à–∞–Ω–±–µ, –ü—Ä–æ—Ñ—Å–∞—é–∑    –î–æ–º–∏ –°–æ—Ñ–∏—è, 3 —ç—Ç–∞–∂  
                <span class="font-medium text-black"> üïê –°–æ–∞—Ç: 14:00          ‚îÇ
‚îÇ</span>
            </p>

            <img src="janna.png"
                 alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä—Å–∞"
                 onerror="this.onerror=null; this.src='https://placehold.co/600x200/F0F0F0/888888?text=–§–æ—Ç–æ+–Ω–µ+–Ω–∞–π–¥–µ–Ω–æ'"
                 class="w-full h-auto rounded-lg my-6 shadow-md object-cover max-h-60 border border-gray-100" />
        </header>

        <section id="registration-section" class="mb-10 p-6 border border-gray-100 rounded-xl shadow-md bg-white">
            <h2 class="text-2xl font-semibold mb-6 text-black border-b pb-2">
                –§–æ—Ä–º–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            </h2>
            <form id="registration-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">–í–∞—à–µ –ò–º—è</label>
                    <input type="text" id="name" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-gray-400 focus:border-gray-400 transition duration-150 bg-gray-50 text-black placeholder-gray-500"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
                        –ù–æ–º–µ—Ä –¢–µ–ª–µ—Ñ–æ–Ω–∞ (TJK)
                    </label>
                    <input type="tel" id="phone" required
                           pattern="[0-9]{9,}" title="–í–≤–µ–¥–∏—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 9 —Ü–∏—Ñ—Ä"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-1 focus:ring-gray-400 focus:border-gray-400 transition duration-150 bg-gray-50 text-black placeholder-gray-500"
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 901234567">
                </div>
                <button type="submit" id="submit-button"
                        class="w-full bg-black text-white py-3 rounded-xl font-bold hover:bg-gray-800 transition duration-200 shadow-md">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <p id="message-area" class="text-center text-sm font-medium pt-2"></p>
            </form>
        </section>

        <section class="text-center p-6 border border-gray-100 rounded-xl shadow-md bg-white">
            <h2 class="text-xl font-semibold mb-4 text-black">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            </h2>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button id="view-participants-btn"
                        class="bg-gray-100 text-gray-700 border border-gray-300 py-3 px-6 rounded-xl font-medium hover:bg-gray-200 transition duration-200 shadow-sm">
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                </button>
                <button id="export-btn"
                        class="bg-gray-100 text-gray-700 border border-gray-300 py-3 px-6 rounded-xl font-medium hover:bg-gray-200 transition duration-200 shadow-sm hidden">
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                </button>
            </div>
        </section>

        <section id="participants-section" class="hidden mt-10 p-6 border border-black rounded-2xl shadow-xl bg-white">
            <h2 class="text-2xl font-bold mb-4 text-black flex justify-between items-center">
                –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –£—á–∞—Å—Ç–Ω–∏–∫–∏
                <button id="close-participants-btn"
                        class="text-sm text-white bg-black py-1 px-3 rounded-full hover:bg-gray-800 transition duration-200">
                    –ó–∞–∫—Ä—ã—Ç—å –°–ø–∏—Å–æ–∫
                </button>
            </h2>
            <div id="participants-list" class="space-y-4 max-h-96 overflow-y-auto">
                <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            <p id="total-participants" class="mt-4 text-md font-semibold text-gray-700"></p>
        </section>

    </div>

    <div id="code-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-black">–¢—Ä–µ–±—É–µ—Ç—Å—è –°–µ–∫—Ä–µ—Ç–Ω—ã–π –ö–æ–¥</h3>
            <p class="mb-4 text-gray-700">–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–ø–∏—Å–∫—É:</p>
            <input type="password" id="secret-code-input"
                   class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-1 focus:ring-gray-400 transition bg-gray-50 text-black"
                   placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥">
            <div class="flex justify-end space-x-3">
                <button id="cancel-code-btn"
                        class="bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button id="submit-code-btn"
                        class="bg-black text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-800 transition">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                </button>
            </div>
            <p id="code-message" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-black"></h3>
            <p id="modal-content" class="mb-6 text-gray-700"></p>
            <button id="close-message-modal"
                    class="bg-black text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-800 transition">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <script>
        const SECRET_CODE = "2010";
        let participants = [];

        const form = document.getElementById('registration-form');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        const messageArea = document.getElementById('message-area');
        const viewParticipantsBtn = document.getElementById('view-participants-btn');
        const exportBtn = document.getElementById('export-btn');
        const participantsSection = document.getElementById('participants-section');
        const participantsList = document.getElementById('participants-list');
        const closeParticipantsBtn = document.getElementById('close-participants-btn');
        const totalParticipants = document.getElementById('total-participants');

        const codeModal = document.getElementById('code-modal');
        const secretCodeInput = document.getElementById('secret-code-input');
        const submitCodeBtn = document.getElementById('submit-code-btn');
        const cancelCodeBtn = document.getElementById('cancel-code-btn');
        const codeMessage = document.getElementById('code-message');

        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeMessageModal = document.getElementById('close-message-modal');

        function showMessage(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        closeMessageModal.onclick = () => {
            messageModal.classList.add('hidden');
            messageModal.classList.remove('flex');
        };

        async function loadParticipantsFromCloud() {
            try {
                const result = await window.storage.get('contest_participants', true);
                if (result && result.value) {
                    participants = JSON.parse(result.value);
                } else {
                    participants = [];
                }
            } catch (error) {
                console.log('–ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö');
                participants = [];
            }
        }

        async function saveParticipantsToCloud() {
            try {
                await window.storage.set('contest_participants', JSON.stringify(participants), true);
                return true;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", error);
                showMessage("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.");
                return false;
            }
        }

        async function handleRegistration(event) {
            event.preventDefault();
            
            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();

            if (!name || !phone) {
                showMessage("–û—à–∏–±–∫–∞", "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
                return;
            }

            messageArea.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
            messageArea.className = 'text-center text-sm font-medium pt-2 text-gray-500';

            await loadParticipantsFromCloud();

            if (participants.some(p => p.phone === phone)) {
                showMessage("–û—à–∏–±–∫–∞", "–£—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.");
                messageArea.textContent = '';
                return;
            }

            const data = {
                name: name,
                phone: phone,
                registeredAt: new Date().toISOString()
            };

            participants.push(data);
            const saved = await saveParticipantsToCloud();

            if (saved) {
                showMessage("–£—Å–ø–µ—Ö!", `–£—á–∞—Å—Ç–Ω–∏–∫ "${name}" —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!`);
                form.reset();
            }
            messageArea.textContent = '';
        }

        async function loadParticipantsList() {
            participantsList.innerHTML = '<p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
            participantsSection.classList.remove('hidden');
            exportBtn.classList.remove('hidden');
            
            await loadParticipantsFromCloud();
            
            const sortedParticipants = [...participants].sort((a, b) => 
                new Date(b.registeredAt) - new Date(a.registeredAt)
            );

            renderParticipants(sortedParticipants);
        }

        function renderParticipants(participantsToRender) {
            if (participantsToRender.length === 0) {
                participantsList.innerHTML = '<p class="text-gray-500">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</p>';
            } else {
                participantsList.innerHTML = participantsToRender.map(p => `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center">
                        <div class="truncate">
                            <p class="font-bold text-black truncate">${p.name}</p>
                            <p class="text-sm text-gray-600">${p.phone}</p>
                        </div>
                        <span class="text-xs text-gray-400 ml-4">${new Date(p.registeredAt).toLocaleDateString('ru-RU')}</span>
                    </div>
                `).join('');
            }
            totalParticipants.textContent = `–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participantsToRender.length}`;
        }

        function hideParticipantsList() {
            participantsSection.classList.add('hidden');
            exportBtn.classList.add('hidden');
        }

        function exportToCSV() {
            if (participants.length === 0) {
                showMessage("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
                return;
            }

            let csv = '–ò–º—è,–¢–µ–ª–µ—Ñ–æ–Ω,–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n';
            participants.forEach(p => {
                csv += `"${p.name}","${p.phone}","${new Date(p.registeredAt).toLocaleString('ru-RU')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `participants_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage("–£—Å–ø–µ—Ö", "–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ CSV.");
        }

        viewParticipantsBtn.onclick = () => {
            secretCodeInput.value = '';
            codeMessage.classList.add('hidden');
            codeModal.classList.remove('hidden');
            codeModal.classList.add('flex');
        };

        submitCodeBtn.onclick = () => {
            const enteredCode = secretCodeInput.value.trim();
            if (enteredCode === SECRET_CODE) {
                codeModal.classList.add('hidden');
                codeModal.classList.remove('flex');
                loadParticipantsList();
            } else {
                codeMessage.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                codeMessage.classList.remove('hidden');
                secretCodeInput.value = '';
            }
        };

        cancelCodeBtn.onclick = () => {
            codeModal.classList.add('hidden');
            codeModal.classList.remove('flex');
        };

        form.addEventListener('submit', handleRegistration);
        closeParticipantsBtn.onclick = hideParticipantsList;
        exportBtn.onclick = exportToCSV;

        window.onload = async () => {
            await loadParticipantsFromCloud();
        };

    </script>
</body>
</html>
